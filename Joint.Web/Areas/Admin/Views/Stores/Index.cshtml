@using Joint.Entity;
@section Style{
    <style type="text/css">
        .form-control {
            display: inline;
        }

        .form-control-feedback {
            display: block;
            height: 30px;
            line-height: 30px;
            position: absolute;
            right: 10px;
            text-align: center;
            top: 0px;
            width: 34px;
        }

        .kv-file-upload {
            display: none;
        }

        .kv-upload-progress > .progress {
            display: none;
        }

        .kv-file-zoom {
            display: none;
        }
    </style>
}
@section HeadScript{
    @*<script type="text/javascript" src="http://api.map.baidu.com/api?v=1.3"></script>*@
}


<div class="page-header">
    <div>
        <button class="btn btn-sm btn-info" data-toggle="modal" id="btn_add" onclick="showAddStores();">
            <i class="icon-plus"></i>
            添加
        </button>

        <div style="float:right;" class="input-group col-xs-12 col-sm-3">
            <input type="text" class="form-control search-query" placeholder="" id="username">
            <span class="input-group-btn">
                <button class="btn btn-purple btn-sm" id="searchbtn" type="button">
                    查询
                    <i class="icon-search icon-on-right bigger-110"></i>
                </button>
            </span>
        </div>
    </div>
</div>


<div class="row">
    <div class="col-xs-12">
        <div class="table-responsive">
            <input id="PermissionType" type="hidden" value="StorePermission">
            <input id="IDs" type="hidden" value="" />
            <table class="table table-striped table-bordered table-hover" id="tbStores"></table>
        </div><!-- /.table-responsive -->
    </div><!-- /span -->
</div>


<div class="modal fade" id="mymodal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title blue lighter"><i class="icon-plus"></i> <label id="modalTitle"> 添加店铺</label></h4>
            </div>
            <div class="modal-body">

                <form id="formStores" method="post" class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">公司名称</label>
                        <div class="col-sm-7">
                            <input type="hidden" name="ID" id="ID">
                            <input type="hidden" name="WifiName" id="WifiName">
                            <input type="hidden" name="WifiPassword" id="WifiPassword">
                            <input type="hidden" name="ShopId" id="ShopId">
                            <input type="text" name="ShopName" class="form-control" id="ShopName" placeholder="商家名称">
                        </div>
                    </div>



                    <div class="form-group">
                        <label class="col-sm-3 control-label">部门名称</label>
                        <div class="col-sm-7">
                            <input type="text" name="StoreName" class="form-control" id="StoreName" placeholder="店铺名称">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-3 control-label">所属部门</label>
                        <div class="col-sm-7">
                            <select id="ParentID" name="ParentID" class="form-control">
                                <option>请选择部门</option>
                            </select>

                        </div>
                    </div>



                    <div class="form-group">
                        <label class="col-sm-3 control-label">电话</label>
                        <div class="col-sm-7">
                            <input type="text" name="Phone" class="form-control" id="Phone" placeholder="电话">
                        </div>
                    </div>



                    @*<div class="form-group">
                            <label class="col-sm-3 control-label">店铺地址</label>
                            <div class="col-sm-7">
                                <input type="text" name="Adress" class="form-control" id="Adress" placeholder="店铺地址"><input type="button" id="btnSearch" value="查询" onclick="searchMap()" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">地图坐标</label>
                            <div class="col-sm-7">
                                <input type="text" name="LatitudeY" class="col-sm-5" id="LatitudeY" placeholder="纬度">
                                <input type="text" name="LongitudeX" class="col-sm-5" id="LongitudeX" placeholder="精度">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-12" style="padding:2% 5% 5%;">
                                <div class="col-sm-12" style="height:340px;border:1px solid #ddd" id="container"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">开户行</label>
                            <div class="col-sm-7">
                                <input type="text" name="BankName" class="form-control" id="BankName" placeholder="开户行" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">银行卡号</label>
                            <div class="col-sm-7">
                                <input type="text" name="BankCard" class="form-control" id="BankCard" placeholder="银行卡号">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">是否共享本店数据</label>
                            <div class="col-sm-7">
                                <label style="padding-top:5px;">
                                    <input type="checkbox" class="ace ace-switch ace-switch-5" name="IsShare" id="IsShare">
                                    <span class="lbl"></span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label"> 显示微信 </label>
                            <div class="col-sm-7">
                                <label style="padding-top:5px;">
                                    <input type="checkbox" class="ace ace-switch ace-switch-5" name="IsShowWeiXin" id="IsShowWeiXin">
                                    <span class="lbl"></span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label"> 是否总店 </label>

                            <div class="col-sm-7">
                                <label style="padding-top:5px;">
                                    <input type="checkbox" class="ace ace-switch ace-switch-5" disabled="disabled" name="IsMainStore" id="IsMainStore">
                                    <span class="lbl"></span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label"> 是否禁用 </label>

                            <div class="col-sm-7">
                                <label style="padding-top:5px;">
                                    <input type="checkbox" class="ace ace-switch ace-switch-5" name="Disabled" id="Disabled">
                                    <span class="lbl"></span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-3 control-label">门店图片</label>
                             <div class="col-sm-9" style="">
                                <div class="col-sm-9" style="padding:0px;">
                                    <input type="file" id="StoresImage" multiple class="file-loading"  />
                                    <input type="hidden" id="StoresImageUpload" class="form-control" name="StoresImage" />
                                </div>
                                <div class="col-sm-3" style="padding:0px;">
                                    <div id="btnStoresImage" class="btn" style="float:left;margin-left:5px; height:44px;"><i class="icon-picture align-top bigger-125"></i></div>

                                </div>
                            </div>
                        </div>
                        <div class="form-group"  style="display:none">
                            <label class="col-sm-3 control-label  no-padding-right"> 小票Logo </label>
                            <div class="col-sm-9">
                                <div class="col-sm-9" style="padding:0px;">
                                    <input type="file" id="ReceiptLogo" multiple class="file-loading" />
                                    <input type="hidden" id="ReceiptLogoUpload" class="form-control" name="ReceiptLogo" />
                                </div>
                                <div class="col-sm-3" style="padding:0px;">
                                    <div id="btnReceiptLogo" class="btn" style="float:left;margin-left:5px; height:44px;"><i class="icon-picture align-top bigger-125"></i></div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group"  style="display:none">
                            <label class="col-sm-3 control-label  no-padding-right"> </label>
                            <div class="col-sm-9 alert alert-danger" style="background-color:#fff;border:none;margin-bottom:0;padding:0">
                                <strong>
                                    <i class="icon-bullhorn"></i>
                                    温馨提示:
                                </strong>
                                小票Logo的图片大小为：128px * 128px
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">打印单尾部声明</label>
                            <div class="col-sm-7">
                                <textarea name="PrintRemark" class="form-control" id="PrintRemark"></textarea>

                            </div>
                        </div>*@
                </form>


            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="icon-remove"></i>关闭</button>
                <button type="button" id="btnAdd" class="btn btn-primary" onclick="addStores();"><i class="icon-plus"></i>添加</button>
                <button type="button" id="btnUpdate" class="btn btn-primary" onclick="editStores();"><i class="icon-save"></i>保存</button>

            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div>



<div class="modal fade" id="RechargeModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title blue lighter"><i class="icon-plus"></i> <label id="modalTitle"> 充值窗口</label></h4>
            </div>
            <div class="modal-body">

                <form id="formStores" method="post" class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">充值门店</label>
                        <div class="col-sm-7">
                            <input id="RechargeStore" type="hidden" />
                            <label style="margin-top:4px" id="RechargeStoreName"></label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">充值条数</label>
                        <div class="col-sm-7">
                            <input type="text" style="cursor: pointer;" name="RechargeCount" class="form-control" id="RechargeCount" onkeyup="$(this).val($(this).val().replace(/[^0-9]/g,''))" placeholder="请输入充值短信条数">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">密码</label>
                        <div class="col-sm-7">
                            <input type="password" style="cursor: pointer;" name="RechargePwd" class="form-control" id="RechargePwd" placeholder="请输入充值密码">
                        </div>
                    </div>



                </form>


            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="icon-remove"></i>关闭</button>
                <button type="button" id="btnUpdate" class="btn btn-primary" onclick="ConfirmRecharge();"><i class="icon-money"></i>充值</button>

            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div>


<div class="modal fade" id="BindVirtualShopModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title blue lighter"><i class="icon-plus"></i> <label id="modalTitle"> 绑定公众号</label></h4>
            </div>
            <div class="modal-body">

                <form id="formStores" method="post" class="form-horizontal">

                    <div class="form-group">
                        <label class="col-sm-4 control-label">请选择要绑定的商家：</label>
                        <div class="col-sm-7">
                            <select id="AllVirtualShops" class="col-xs-12"></select>
                        </div>
                    </div>



                </form>


            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal"><i class="icon-remove"></i>关闭</button>
                <button type="button" id="btnBind" class="btn btn-primary" onclick="ConfirmBindVirtualShop();"><i class="icon-lock"></i>绑定</button>

            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div>

@section FootScript{

    <!-- bootstrap-table js -->
    <script src="~/Areas/Admin/Content/bootstrap-table/bootstrap-table.js"></script>
    <link href="~/Areas/Admin/Content/bootstrap-table/bootstrap-table.css" rel="stylesheet" />
    <script src="~/Areas/Admin/Content/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
    <!-- bootstrap-table js -->
    <!-- bootstrap-fileinput js -->
    <link href="~/Content/bootstrap-fileinput/css/fileinput.min.css" rel="stylesheet" />
    <script src="~/Scripts/fileinput.min.js"></script>
    <script src="~/Scripts/fileinput_locale_zh.js"></script>

    <!-- 下拉插件 -->
    <script src="~/Areas/Admin/Content/DropdownJs/jquery.dropdown.js"></script>
    <!-- 省市县插件 -->
    <script src="~/Scripts/PCASClass.js"></script>

    <!-- bootstrap-fileinput js -->
    @*<script type="text/javascript">

            $(function () {
                //1.初始化Table
                var oTable = new TableInit();
                oTable.Init();
                //2.初始化Button的点击事件
                var oButtonInit = new ButtonInit();
                oButtonInit.Init();

                $("#searchbtn").click(function () {
                    oTable.Init();
                });
            });

            var TableInit = function () {
                var oTableInit = new Object();
                //初始化Table
                oTableInit.Init = function () {
                    $('#tbStores').bootstrapTable({
                        url: '@Url.Action("GetStores", "Stores")',		 //请求后台的URL（*）
                        method: 'get',                      //请求方式（*）
                        striped: true,                      //是否显示行间隔色
                        cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
                        pagination: true,                   //是否显示分页（*）
                        sortable: true,                     //是否启用排序
                        sortOrder: "asc",                   //排序方式
                        queryParams: oTableInit.queryParams,//传递参数（*）
                        queryParamsType: "undefined",
                        sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
                        pageSize: 3,                       //每页的记录行数（*）
                        pageNumber: 1,                       //初始化加载第一页，默认第一页
                        pageList:null,
                        search: false,                       //是否显示表格搜索，此搜索是客户端搜索，不会进服务端，所以，个人感觉意义不大
                        strictSearch: false,
                        showColumns: false,                  //是否显示所有的列
                        showRefresh: false,                  //是否显示刷新按钮
                        clickToSelect: true,                //是否启用点击选中行
                        uniqueId: "Name",                     //每一行的唯一标识，一般为主键列
                        showToggle: false,                    //是否显示详细视图和列表视图的切换按钮
                        cardView: false,                    //是否显示详细视图
                        detailView: false,                   //是否显示父子表
                        columns: [{
                            checkbox: true
                        }, {
                            field: 'StoreName',
                            title: '门店'
                        }, {
                            field: 'Phone',
                            title: '电话'
                        }, {
                            field: 'Adress',
                            title: '地址'
                        }, {
                            field: 'IsShowWeiXin',
                            title: '微信'
                        }, {
                            field: 'IsMainStore',
                            title: '是否总店'
                        }]
                    });
                };
                //得到查询的参数
                oTableInit.queryParams = function (params) {
                    var temp = {   //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的IsMainStore
                        pageSize: params.pageSize,   //页面大小
                        pageNumber: params.pageNumber,  //页码
                        username: $("#username").val()
                    };
                    return temp;
                };
                return oTableInit;
            };
            var ButtonInit = function () {
                var oInit = new Object();
                var postdata = {};
                oInit.Init = function () {
                    //初始化页面上面的按钮事件

                };
                return oInit;
            };
        </script>*@

    <script type="text/javascript">
        var currentStore = null;
        //初始化fileinput
        function initTable() {
            //先销毁表格
            $('#tbStores').bootstrapTable('destroy');
            //初始化表格,动态从服务器加载数据
            $("#tbStores").bootstrapTable({
                method: "get",  //使用get请求到服务器获取数据
                url: "@Url.Action("GetStores", "Stores")", //获取数据的Servlet地址
                striped: true,  //表格显示条纹
                pagination: true, //启动分页
                pageSize: 10,  //每页显示的记录数
                pageNumber: 1, //当前第几页
                search: false,  //是否启用查询
                showColumns: false,  //显示下拉框勾选要显示的列
                showRefresh: false,  //显示刷新按钮
                sidePagination: "server", //表示服务端请求
                //设置为undefined可以获取pageNumber，pageSize，searchText，sortName，sortOrder
                //设置为limit可以获取limit, offset, search, sort, order
                queryParamsType: "undefined",
                queryParams: function queryParams(params) {   //设置查询参数
                    var param = {
                        pageNumber: params.pageNumber,
                        pageSize: params.pageSize,
                        username: $("#username").val(),
                        shopID: $.getUrlParam("shopID")
                    };
                    return param;
                },
                columns: [{
                    checkbox: true
                },
                {
                    field: 'ShopsID',
                    title: '公司ID',
                    visible: false
                }
                , {
                    field: 'ID',
                    title: '编号'
                }, {
                    field: 'ShopsName',
                    title: '公司名称'
                }, {
                    field: 'StoreName',
                    title: '部门'
                }, {
                    field: 'ParentStoreName',
                    title: '所属部门'
                }, {
                    field: 'Phone',
                    title: '电话'
                }, {
                    field: 'Disabled',
                    title: '状态',
                    formatter: function (value) {

                        if (value == true)
                            return '<span class="label label-sm label-danger" >禁用</span>';
                        else
                            return '<span class="label label-sm label-success" >正常</span>';
                    }
                }, {
                    field: 'Oprate',
                    title: '操作',
                    formatter: function (value, row, index) {
                        return [
                       '<button class="btn btn-xs btn-info" onClick="showEditStores(' + row.ID + ')"><i class="icon-edit bigger-120"></i>编辑</button>',
                       '<button class="btn btn-xs btn-purple" onClick="assignShopPermissions(' + row.ID + ')"><i class="icon-key bigger-120"></i>菜单</button>',
                       '<button class="btn btn-xs btn-danger"' + styleShowOrHide(!row.Disabled) + ' onClick="del(' + row.ID + ')"><i class="icon-remove bigger-120"></i>禁用</button>',
                       '<button class="btn btn-xs btn-success"' + styleShowOrHide(row.Disabled) + ' onClick="reDel(' + row.ID + ')"><i class="icon-undo bigger-120"></i>启用</button>',
                        ].join('  ');
                    }
                }],
                onLoadSuccess: function () {  //加载成功时执行
                    $(".page-list").css("display", "none");
                    //layer.msg("加载成功", { time: 1000 });
                },
                onLoadError: function () {  //加载失败时执行
                    layer.msg("加载数据失败", { time: 1500, icon: 2 });
                }
            });
        };


        function ShowShopPermissionMenu(id) {
            //iframe层-父子操作
            var openIndex = layer.open({
                type: 2,
                area: ['680px', '700px'],
                fix: false, //不固定
                maxmin: true,
                title: "权限分配",
                content: '/Admin/Permission/ShopPermissionMenu?storeID=' + id
            });

        }
        var virtualShops = null;
        function BindVirtualShop(id, shopID) {
            $("#AllVirtualShops").html("");
            var paramConfig = { reqUrl: "/Admin/Stores/GetVirtualShops", isAsync: false, data: "shopID=" + shopID };
            CallAjax(paramConfig, function () {

                virtualShops = (ReturnedResult.VirtualShops);
                for (var i = 0; i < virtualShops.length; i++) {
                    $("#AllVirtualShops").append("<option value='" + virtualShops[i].Value + "'>" + virtualShops[i].Text + "</option>");
                }
            });

            currentStore = id;
            $("#BindVirtualShopModal").modal('toggle');
        }
        function ConfirmBindVirtualShop() {
            if ($("#AllVirtualShops").val() == "" || $("#AllVirtualShops").val() == null) {
                layer.msg("请选择要绑定的商家！"); return;
            }
            ToggleVirtualShop($("#AllVirtualShops").val());
        }
        function ToggleVirtualShop(virtualShopsID) {
            var paramConfig = { reqUrl: "/Admin/Stores/ToggleVirtualShops", data: "storeID=" + currentStore + "&virtualShopsID=" + virtualShopsID };
            CallAjax(paramConfig, function () {
                layer.msg(ReturnedResult.msg);

                $("#BindVirtualShopModal").modal('hide');
                $("#tbStores").bootstrapTable('refresh');
            }, function () {
                layer.msg(ReturnedResult.msg);
            });
        }

        function UnbindVirtualShop(id) {
            currentStore = id;
            layer.confirm('你确定要解绑此门店所绑定的公众号？', {
                btn: ['确定', '取消'] //按钮
            }, function () {
                ToggleVirtualShop();
            }, function () {
                layer.msg('已取消', { icon: 1, time: 1000 });
            });
        }
        function assignShopPermissions(id) {
            $("#IDs").val(id);
            ShowShopPermissionMenu(id);
        }
        function Recharge(id, name) {
            $("#RechargeStore").val(id);
            $("#RechargeStoreName").text(name);
            $("#RechargeModal").modal('toggle');
        }
        function ConfirmRecharge() {


            var loading = layer.msg('正在充值中', {
                time: 0,
                icon: 16,
                shade: 0.01
            });

            var paramConfig = { reqUrl: "/Admin/ShortMessage/RechargeMoney", data: "storeID=" + $("#RechargeStore").val() + "&count=" + $("#RechargeCount").val() + "&pwd=" + $("#RechargePwd").val() };
            CallAjax(paramConfig, function () {
                layer.close(loading); $("#RechargeModal").modal('hide'); layer.msg(ReturnedResult.msg);
            });

        }

        function reDel(id) {
            layer.confirm('你确定要启用此数据么？', {
                btn: ['确定', '取消'] //按钮
            }, function () {
                var loading = layer.load(1, {
                    shade: [0.1, '#fff'] //0.1透明度的白色背景
                });
                $.ajax({
                    type: "post",
                    url: "@Url.Action("ReDisableStores", "Stores")",
                    data: { "SID": id },
                    success: function (result) {
                        layer.close(loading);
                        if (result.success) {
                            layer.msg(result.msg);
                            $("#tbStores").bootstrapTable('refresh');
                        } else {
                            layer.msg(result.msg);
                        }
                    },
                    complete: function () {

                    }
                });

            }, function () {
                layer.msg('已取消', { icon: 1, time: 1000 });
            });
        }


        function del(id) {
            layer.confirm('你确定要禁用此数据么？', {
                btn: ['确定', '取消'] //按钮
            }, function () {
                var loading = layer.load(1, {
                    shade: [0.1, '#fff'] //0.1透明度的白色背景
                });
                $.ajax({
                    type: "post",
                    url: "@Url.Action("DisableStores", "Stores")",
                    data: { "SID": id },
                    success: function (result) {
                        layer.close(loading);
                        if (result.success) {
                            layer.msg(result.msg);
                            $("#tbStores").bootstrapTable('refresh');
                        } else {
                            layer.msg(result.msg);
                        }
                    },
                    complete: function () {

                    }

                });

            }, function () {
                layer.msg('已取消', { icon: 1, time: 1000 });
            });
        }



        var FileInput = function () {
            var oFile = new Object();

            //初始化fileinput控件（第一次初始化）
            oFile.Init = function (ctrlName, uploadUrl) {
                var control = $('#' + ctrlName);


                //初始化上传控件的样式
                control.fileinput({
                    language: 'zh', //设置语言
                    uploadUrl: uploadUrl, //上传的地址
                    uploadAsync: true, //默认异步上传
                    allowedFileExtensions: ['jpg', 'gif', 'png'],//接收的文件后缀
                    showUpload: false, //是否显示上传按钮
                    showCaption: true,//是否显示标题
                    browseClass: "btn btn-xs btn-primary", //按钮样式
                    removeClass: "btn btn-xs btn-default",
                    cancelClass: "btn btn-xs btn-default",
                    uploadClass: "btn btn-xs btn-default",
                    showPreview: false,//是否显示图片预览
                    dropZoneEnabled: false,//是否显示拖拽区域

                    //dropZoneEnabled: false,//是否显示拖拽区域
                    //minImageWidth: 50, //图片的最小宽度
                    //minImageHeight: 50,//图片的最小高度
                    //maxImageWidth: 1000,//图片的最大宽度
                    //maxImageHeight: 1000,//图片的最大高度
                    //maxFileSize: 0,//单位为kb，如果为0表示不限制文件大小
                    //minFileCount: 0,
                    maxFileCount: 1, //表示允许同时上传的最大文件个数
                    enctype: 'multipart/form-data',
                    validateInitialCount: true,
                    previewFileIcon: "<i class='glyphicon glyphicon-king'></i>",
                    msgFilesTooMany: "选择上传的文件数量({n}) 超过允许的最大数值{m}！",
                }).on("filebatchselected", function (event, files) {
                    $("#" + ctrlName).fileinput("upload");
                });
            }
            return oFile;
        };

        //设置模态窗口，1添加2编辑
        function SetModule(tp) {
            if (tp == 1) {
                $('#formStores')[0].reset()
                $("#btnAdd").show();
                $("#btnUpdate").hide();
                $("#modalTitle").html("添加门店");

                $('#ParentID').removeAttr("disabled");
                $('#ParentID').empty();
                $('#ParentID').append($('<option></option>').val(null).text("请选择部门"));
                $('#ParentID').append($('<option></option>').val(0).text("顶级部门"));
            }
            else {
                $("#btnAdd").hide();
                $("#btnUpdate").show();
                $("#modalTitle").html("编辑门店");
            }
        }

        function editStores() {


            if ($("#ShopId").val() == "" && $("#ShopName").val() == "") {
                layer.msg("错误，商家不能为空");
                return;
            }


            var validateResult = $('#formStores').bootstrapValidator('validate').data('bootstrapValidator');
            if (!validateResult.isValid()) {
                return;
            }
            var storeJson = $("#formStores").serializeJson();

            var loading = layer.load(1, {
                shade: [0.1, '#fff'] //0.1透明度的白色背景
            });


            $.ajax({
                type: "Post",
                url: "/Admin/Stores/EditStores",
                data: storeJson,
                success: function (result) {

                    layer.close(loading);

                    if (result.success) {
                        $('#mymodal').modal('hide');
                        $("#tbStores").bootstrapTable('refresh');
                    }
                    else {
                        layer.msg(result.msg);
                    }
                }
            });
        }

        function addStores() {

            if ($("#ShopId").val() == "" && $("#ShopName").val() == "") {
                layer.msg("请选择商家");
                return;
            }

            var validateResult = $('#formStores').bootstrapValidator('validate').data('bootstrapValidator');
            if (!validateResult.isValid()) {
                return;
            }

            var storeJson = $("#formStores").serializeJson();
            //storeJson.IsMainStore = $("#IsMainStore").is(":Checked") ? 0 : -1;

            var loading = layer.load(1, {
                shade: [0.1, '#fff'] //0.1透明度的白色背景
            });


            $.ajax({
                type: "Post",
                url: "/Admin/Stores/AddStores",
                data: storeJson,
                success: function (result) {

                    layer.close(loading);
                    if (result.success) {
                        location.reload();
                    }
                    else {

                        layer.msg(result.msg);
                    }
                }
            });

        }

        function showAddStores() {
            SetModule(1);
            $("#mymodal").modal("toggle");
        }
        function showStoreImg(imgUrl, width, height) {
            layer.open({
                type: 2,
                title: false,
                closeBtn: 0,
                area: [width, height],
                skin: 'layui-layer-nobg', //没有背景色
                shadeClose: true,
                content: imgUrl
            });
        }
        function showEditStores(id) {

            SetModule(2);


            var loading = layer.load(1, {
                shade: [0.1, '#fff'] //0.1透明度的白色背景
            });

            $.post('/Admin/Stores/GetStoresByID',
            { ID: id },
            function (result) {
                layer.close(loading);
                $.loadData(result, "#formStores");


                //    $("#StoreName").val(result.StoreName);
                if (!$.isNullOrEmpty($("#ShopId").val())) {
                    getStoreTree($("#ShopId").val());
                }

                if (!$.isNullOrEmpty(result.StoresImage)) {
                    $("#btnStoresImage").addClass("btn-danger");
                    $("#btnStoresImage").unbind();
                    $("#btnStoresImage").click(function () {
                        showStoreImg(result.StoresImage, "600px", "400px");
                    });
                }

                if (!$.isNullOrEmpty(result.ReceiptLogo)) {
                    $("#btnReceiptLogo").addClass("btn-danger");
                    $("#btnReceiptLogo").unbind();
                    $("#btnReceiptLogo").click(function () {
                        showStoreImg(result.ReceiptLogo, "128px", "128px");
                    });
                }

                //$("#DueDate").val(result.DueDate.substr(0, 10));
                $("#mymodal").modal("toggle");

                if (!$.isNullOrEmpty(result.ParentID) || result.ParentID == 0) {
                    $("#ParentID").val(result.ParentID);
                }

                if (result.success == false) {
                    layer.msg(result.msg);
                }
            },
            "json"
            );
        }
        function showQRCodeImg(imgUrl) {
            layer.open({
                type: 2,
                title: false,
                closeBtn: 0,
                area: ['349px', '349px'],
                skin: 'layui-layer-nobg', //没有背景色
                shadeClose: true,
                content: imgUrl
            });
        }

        function styleShowOrHide(isShow) {
            if (isShow) {
                return '';
            }
            else {
                return 'style="display:none;"';
            }
        }

        $(document).ready(function () {

            //1.调用函数，初始化表格
            initTable();

            //2.初始化fileinput 圖片上傳
            var oFileInput = new FileInput();
            //  oFileInput.Init("StoresImage", "@Url.Action("GetStores", "Stores")");
            oFileInput.Init("StoresImage", "/Common/Upload/UploadImg");



            var oFileInput2 = new FileInput();
            oFileInput2.Init("ReceiptLogo", "/Common/Upload/UploadImg");

            //当点击查询按钮的时候执行
            $("#searchbtn").bind("click", initTable);

            $("#ReceiptLogo").on("fileuploaded", function (event, data, previewId, index) {
                if (data.response.success) {
                    $("#ReceiptLogoUpload").val(data.response.msg);
                } else {
                    layer.msg('文件上传失败，请检测文件格式是否为图片', { icon: 2, time: 1000 });
                    return;
                }
            }).on("filecleared", function (event, data, previewId, index) {
                $("#ReceiptLogoUpload").val("");
            });
            $("#StoresImage").on("fileuploaded", function (event, data, previewId, index) {
                if (data.response.success) {
                    $("#StoresImageUpload").val(data.response.msg);
                } else {
                    layer.msg('文件上传失败，请检测文件格式是否为图片', { icon: 2, time: 1000 });
                    return;
                }
            }).on("filecleared", function (event, data, previewId, index) {
                $("#StoresImageUpload").val("");
            });


        });

        function InitValidator() {
            $('#formStores').bootstrapValidator({
                message: 'This value is not valid',
                feedbackIcons: {
                    valid: 'glyphicon glyphicon-ok',
                    invalid: 'glyphicon glyphicon-remove',
                    validating: 'glyphicon glyphicon-refresh'
                },
                fields: {
                    StoreName: {
                        validators: {
                            notEmpty: {
                                message: '店铺名不能为空'
                            }
                        }
                    },
                    ParentID: {
                        validators: {
                            notEmpty: {
                                message: '请选择所属门店'
                            }
                        }
                    },
                    Adress: {
                        validators: {
                            notEmpty: {
                                message: '门店地址不能为空'
                            }
                        }
                    },
                    //BankCard: {
                    //    validators: {
                    //        notEmpty: {
                    //            message: '银行卡号不能为空'
                    //        },
                    //        regexp: {
                    //            regexp: /^(\d{16}|\d{19})$/,
                    //            message: '请输入正确的银行卡号'
                    //        }
                    //    }
                    //},
                    Phone: {
                        validators: {
                            regexp: {
                                regexp: /^(0[0-9]{2,3}\-)?([2-9][0-9]{6,7})+(\-[0-9]{1,4})?$|(^(1[0-9][0-9]|15[0|3|6|7|8|9]|18[8|9])\d{8}$)/,
                                message: '请输入正确的电话号码'
                            }
                        }
                    }
                }
            });
        }

        function getStoreTree(ShopId) {

            $.ajax({
                type: "post",
                data: { ShopID: ShopId },
                async: false,
                url: "/admin/Stores/GetStoresTreeByShopID",
                success: function (result) {
                    if (result.length > 0) {
                        $('#ParentID').removeAttr("disabled");
                        $('#ParentID').empty();
                        $('#ParentID').append($('<option></option>').val(null).text("请选择部门"));
                        $('#ParentID').append($('<option></option>').val(0).text("顶级部门"));
                        $.each(result, function (i, item) {
                            $('#ParentID').append($('<option></option>').val(item.Key).text(item.Value));
                        });
                    }
                },
                complete: function () {

                }

            });
        }


        $(function () {
            InitValidator();




            $("#ShopName").YBdropTable({
                dropwidth: "auto", //下拉层的宽度
                editable: false,//设置当前控件是否可以被编辑
                tableoptions: {
                    autoPost: true,//输入文本框的时候，是否自动回发服务器获取数据
                    autoload: true,//点开下拉框的时候是否自动在加载数据
                    url: "/Admin/Shops/GetShopsJson", //查询响应的地址
                    qtitletext: "请输入关键字...", //下拉查询框的默认文字
                    qtextWidth: 305,//查询输入框的长度
                    pagesize: 5,//分页大小
                    showSearch: true,//显示搜索框
                    showTableTH: true,//显示表头
                    showPager: true, //显示分页控件
                    multipleChoices: false,//是否多选，保留字段，后期拓展，目前不支持多选
                    colmodel://表格列定义
                        [
                        { name: "ID", displayname: "编号", width: "50px", visible: false },
                        { name: "ShopName", displayname: "商家名称", width: "100px", visible: true },
                        { name: "DueDate", displayname: "到期日期", width: "100px", visible: true }
                        ],

                    //单选回调函数，返回被选行的json对象，非json字符串,直接对象点出属性即可，如jsonResult.ID
                    singleSelectFunc: function (jsonResult) {
                        $("#ShopId").val(jsonResult.ID);
                        $("#ShopName").val(jsonResult.ShopName);
                        getStoreTree(jsonResult.ID);

                    }
                }
            });


            //$('#btnAdd').click();


        });

    </script>


}
